{% extends "layout.html" %} {% block title %} Quote {% endblock %} {% block main %}
<h1>Search</h1>
<br />
<form id="quote-form">
	<div class="mb-3">
		<input
			autocomplete="off"
			autofocus
			class="form-control mx-auto w-auto quote-input"
			name="symbol"
			placeholder="Symbol"
			type="text"
		/>
	</div>
	<button class="btn btn-primary quote-button" type="submit">Get Quote</button>
	<div class="d-flex justify-content-center">
		<div class="spinner-border text-primary quote-spinner" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
	</div>
</form>

<div class="table-container">
	<table style="display: none">
		<thead>
			<tr>
				<th>Company Name</th>
				<th>Symbol</th>
				<th>Shares</th>
				<th>Price</th>
				<th>Value</th>
				<th>Sell</th>
				<th>Buy</th>
			</tr>
		</thead>
		<tbody>
			<tr class="holding">
				<td class="name"></td>
				<td class="symbol"></td>
				<td class="current-shares"></td>
				<td class="price"></td>
				<td class="value"></td>
				<td><input type="number" name="shares" class="sell-input" disabled step="1" form="sell-form" /></td>
				<td><input type="number" name="shares" class="buy-input" disabled step="1" form="buy-form" /></td>
			</tr>
		</tbody>
		<tfoot>
			<tr>
				<td></td>
				<td></td>
				<td></td>
				<td class="footer">Total</td>
				<td></td>
				<td class="sell-total"></td>
				<td class="buy-total"></td>
			</tr>
			<tr>
				<td></td>
				<td></td>
				<td></td>
				<td class="footer">Balance</td>
				<td class="balance">
					<div class="spinner-border spinner-border-sm text-primary" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
				</td>
				<td>
					<form class="sell-form">
						<input type="hidden" name="symbol" />
						<input type="hidden" name="price" />
						<input type="hidden" name="current_shares" />
						<button type="submit" class="btn btn-primary sell-button" disabled>Sell</button>
						<div class="spinner-border text-primary sell-spinner" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
					</form>
				</td>
				<td>
					<form class="buy-form">
						<input type="hidden" name="symbol" />
						<input type="hidden" name="price" />
						<input type="hidden" name="current_shares" />
						<button type="submit" class="btn btn-primary buy-button" disabled>Buy</button>
						<div class="spinner-border text-primary buy-spinner" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
					</form>
				</td>
			</tr>
		</tfoot>
	</table>
</div>
<span class="message"></span>
{% endblock %} {% block script%}

<script>
	document.addEventListener("DOMContentLoaded", async () => {
		const message = document.querySelector(".message");
		const INTERVAL = JSON.parse(localStorage.getItem("INTERVAL"));

		const balanceCell = document.querySelector(".balance");

		let balance = await fetchBalance();
		if (balance) {
			balanceCell.textContent = `$${balance.toFixed(2)}`;
		} else {
			balanceCell.textContent = `$--`;
			balanceCell.style.color = "red";
		}

		const allButtons = document.querySelectorAll("button");

		const quoteSpinner = document.querySelector(".quote-spinner");
		const quoteButton = document.querySelector(".quote-button");
		const quoteTable = document.querySelector("table");
		const quoteInput = document.querySelector(".quote-input");

		const nameCell = document.querySelector(".name");
		const symbolCell = document.querySelector(".symbol");
		const priceCell = document.querySelector(".price");
		const sharesCell = document.querySelector(".current-shares");
		const valueCell = document.querySelector(".value");

		const buySpinner = document.querySelector(".buy-spinner");
		const buyButton = document.querySelector(".buy-button");

		const sellSpinner = document.querySelector(".sell-spinner");
		const sellButton = document.querySelector(".sell-button");

		const buyForm = document.querySelector(".buy-form");
		const sellForm = document.querySelector(".sell-form");

		const buyInput = document.querySelector(".buy-input");
		const sellInput = document.querySelector(".sell-input");

		const buyTotal = document.querySelector(".buy-total");
		const sellTotal = document.querySelector(".sell-total");

		let priceIntervalId;
		let transactionInProgress;

		const fetchShares = async (symbol) => {
			const res = await fetch(`/holdings?symbol=${encodeURIComponent(symbol)}`);
			if (!res.ok) throw new Error(`Error ${res.status}: ${res.statusText}`);
			const data = await res.json();
			if (!data || data.shares == undefined) throw new Error("Missing data");
			return data.shares;
		};

		const updateShares = async (symbol) => {
			try {
				const shares = await fetchShares(symbol);
				sharesCell.dataset.value = sharesCell.textContent = shares;
				buyForm.current_shares.value = sellForm.current_shares.value = shares;
				sellInput.max = shares;
				if (shares > 0) {
					sellInput.disabled = false;
					sellButton.disabled = false;
					sellInput.min = 1;
				}
				return shares;
			} catch (error) {
				console.error(error);
				throw error;
			}
		};

		const fetchPrice = async (symbol) => {
			const res = await fetch(`/prices?symbols=${encodeURIComponent(symbol)}`);
			const data = await res.json().catch((error) => console.error(error));
			if (!res.ok) {
				const error = new Error(data && data.error ? data.error : `Error ${res.status}: ${res.statusText}`);
				error.status = res.status;
				throw error;
			}
			if (!data || !data[0] || data[0].symbol !== symbol || !data[0].name)
				throw new Error("Missing or invalid data");

			const price = data[0].price;
			if (typeof price !== "number" || Number.isNaN(price) || price <= 0) {
				throw new Error(`Invalid price received for holding: ${symbol}`);
			}
			return data[0];
		};

		const updatePrice = async (symbol, isFirstLoad = false) => {
			try {
				const { price, name } = await fetchPrice(symbol);
				if (isFirstLoad) {
					nameCell.textContent = name;
					buyTotal.textContent = "";
					sellTotal.textContent = "";
				}
				priceCell.style.color = valueCell.style.color = "";
				priceCell.dataset.value = price;
				priceCell.textContent = `$${price.toFixed(2)}`;
				sellForm.price.value = buyForm.price.value = price;
				const availableShares = Math.floor(balance / price);
				buyInput.max = availableShares;

				const available = availableShares > 0;
				if (!transactionInProgress) buyInput.disabled = buyButton.disabled = available ? false : true;
				buyInput.min = available ? 1 : 0;

				return price;
			} catch (error) {
				console.error(error);
				if (isFirstLoad) throw error;
				priceCell.style.color = valueCell.style.color = "red";
				return null;
			}
		};

		const quoteForm = document.getElementById("quote-form");
		quoteForm.addEventListener("submit", async (e) => {
			e.preventDefault();
			const shareSymbol = document.querySelector(".quote-input").value.trim().toUpperCase();

			if (!shareSymbol) {
				message.textContent = "Invalid input - please enter a symbol.";
				return;
			}

			quoteButton.style.display = "none";
			quoteSpinner.style.setProperty("display", "flex", "important");
			quoteTable.style.display = "none";
			message.textContent = "";
			sellInput.value = buyInput.value = "";

			try {
				const [shares, sharePrice] = await Promise.all([
					updateShares(shareSymbol),
					updatePrice(shareSymbol, true),
				]);
				buyForm.symbol.value = sellForm.symbol.value = shareSymbol;
				symbolCell.textContent = shareSymbol;
				valueCell.textContent = `$${(shares * sharePrice).toFixed(2)}`;
				quoteTable.style.display = "";
				if (priceIntervalId) clearInterval(priceIntervalId);

				priceIntervalId = setInterval(() => {
					updatePrice(shareSymbol).then(() => {
						if (!transactionInProgress) {
							if (buyTotal.textContent) buyInput.dispatchEvent(new Event("input"));
							if (sellTotal.textContent) sellInput.dispatchEvent(new Event("input"));
						}
					});
				}, INTERVAL);
			} catch (error) {
				message.textContent = error?.status == 404 ? error?.message : "Unexpected error";
			} finally {
				quoteButton.style.display = "";
				quoteSpinner.style.setProperty("display", "none", "important");
			}
		});

		buyForm.addEventListener("submit", async (e) => {
			e.preventDefault();
			if (transactionInProgress) return;
			transactionInProgress = true;
			message.textContent = "";
			const shares = Number(buyInput.value);
			if (shares < 0 || !Number.isInteger(shares) || (!buyInput.checkValidity() && buyInput.value !== "0")) {
				message.textContent = "Invalid input - must be a positive integer.";
				transactionInProgress = false;
				return;
			}
			if (!shares) {
				message.textContent = "No shares selected to trade.";
				transactionInProgress = false;
				return;
			}
			if (shares > Number(buyInput.max)) {
				message.textContent = "Could not complete trade - insufficient funds.";
				transactionInProgress = false;
				return;
			}
			try {
				buySpinner.style.setProperty("display", "flex", "important");
				buyButton.style.display = "none";
				document.querySelectorAll("input, button").forEach((el) => (el.disabled = true));
				const purchase = {};
				purchase[buyForm.symbol.value] = shares;

				const res = await fetch("/buy", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
					body: JSON.stringify(purchase),
				});
				const data = await res.json();

				if (!res.ok) {
					let message;

					if (res.status === 422 && data?.failed?.[0]?.error) {
						message = data.failed[0].error;
					} else if (data?.error) {
						message = data.error;
					} else {
						message = `Error ${res.status}: ${res.statusText}`;
					}

					const err = new Error(message);
					err.status = res.status;
					throw err;
				}
				if (!data || isNaN(Number(data.updated_balance))) throw new Error("Missing or invalid data");

				const updatedBalance = Number(data.updated_balance);

				message.textContent = "Purchase Successful!";
				setBalance(updatedBalance);
				balanceCell.style.color = "";
				balanceCell.textContent = `$${updatedBalance.toFixed(2)}`;
				balance = updatedBalance;
				const updatedShares = Number(buyForm.current_shares.value) + shares;
				buyForm.current_shares.value = sellForm.current_shares.value = updatedShares;
				const updatedValue = Number(buyForm.price.value) * updatedShares;
				valueCell.textContent = `$${updatedValue.toFixed(2)}`;
				sharesCell.textContent = updatedShares;
				sharesCell.dataset.value = updatedShares;
				sellInput.max = updatedShares;
				const price = Number(buyForm.price.value);
				const availableShares = price > 0 ? Math.floor(updatedBalance / price) : 0;
				buyInput.max = availableShares;
				buyInput.value = sellInput.value = "";
				buyTotal.textContent = sellTotal.textContent = "";
			} catch (error) {
				console.error(error);
				message.textContent = [400, 422].includes(error.status) ? error.message : "Unexpected error";
			} finally {
				buySpinner.style.setProperty("display", "none", "important");
				buyButton.style.display = "";
				quoteButton.disabled = quoteInput.disabled = false;

				const buyMax = Number(buyInput.max) > 0;
				buyInput.disabled = buyButton.disabled = !buyMax;
				buyInput.min = buyMax ? 1 : 0;

				const sellMax = Number(sellInput.max) > 0;
				sellInput.disabled = sellButton.disabled = !sellMax;
				sellInput.min = sellMax ? 1 : 0;
				transactionInProgress = false;
			}
		});

		sellForm.addEventListener("submit", async (e) => {
			e.preventDefault();
			if (transactionInProgress) return;
			transactionInProgress = true;
			message.textContent = "";
			const shares = Number(sellInput.value);
			if (shares < 0 || !Number.isInteger(shares) || (!sellInput.checkValidity() && sellInput.value !== "0")) {
				message.textContent = "Invalid input - must be a positive integer.";
				transactionInProgress = false;
				return;
			}
			if (!shares) {
				message.textContent = "No shares selected to trade.";
				transactionInProgress = false;
				return;
			}
			if (shares > Number(sellForm.current_shares.value)) {
				message.textContent = "Could not complete trade - insufficient shares.";
				transactionInProgress = false;
				return;
			}
			try {
				sellSpinner.style.setProperty("display", "flex", "important");
				sellButton.style.display = "none";
				document.querySelectorAll("input, button").forEach((el) => (el.disabled = true));
				const sale = {};
				sale[sellForm.symbol.value] = shares;
				const res = await fetch("/sell", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
					body: JSON.stringify(sale),
				});
				const data = await res.json();
				if (!res.ok) {
					let message;
					if (res.status === 422 && data?.failed?.[0]?.error) {
						message = data.failed[0].error;
					} else if (data?.error) {
						message = data.error;
					} else {
						message = `Error ${res.status}: ${res.statusText}`;
					}

					const err = new Error(message);
					err.status = res.status;
					throw err;
				}
				if (!data || isNaN(Number(data.updated_balance))) throw new Error("Missing or invalid data");

				message.textContent = "Sale successful!";
				const updatedBalance = Number(data.updated_balance);
				setBalance(updatedBalance);
				balanceCell.style.color = "";
				balanceCell.textContent = `$${updatedBalance.toFixed(2)}`;
				balance = updatedBalance;
				const updatedShares = Number(sellForm.current_shares.value) - shares;
				buyForm.current_shares.value = sellForm.current_shares.value = updatedShares;
				const updatedValue = Number(sellForm.price.value) * updatedShares;
				valueCell.textContent = `$${updatedValue.toFixed(2)}`;
				sharesCell.textContent = updatedShares;
				sharesCell.dataset.value = updatedShares;
				const price = Number(buyForm.price.value);
				const availableShares = price > 0 ? Math.floor(updatedBalance / price) : 0;
				buyInput.max = availableShares;
				sellInput.max = updatedShares;
				buyInput.value = sellInput.value = "";
				buyTotal.textContent = sellTotal.textContent = "";
			} catch (error) {
				console.error(error);
				message.textContent = 422 === error.status ? error.message : "Unexpected error";
			} finally {
				sellSpinner.style.setProperty("display", "none", "important");
				sellButton.style.display = "";
				quoteButton.disabled = quoteInput.disabled = false;

				const buyMax = Number(buyInput.max) > 0;
				buyInput.disabled = buyButton.disabled = !buyMax;
				buyInput.min = buyMax ? 1 : 0;

				const sellMax = Number(sellInput.max) > 0;
				sellInput.disabled = sellButton.disabled = !sellMax;
				sellInput.min = sellMax ? 1 : 0;

				transactionInProgress = false;
			}
		});

		buyInput.addEventListener("input", (event) => {
			buyTotal.textContent = isNaN(buyInput.valueAsNumber)
				? ""
				: `$${(Number(priceCell.dataset.value) * Number(buyInput.value)).toFixed(2)}`;
		});

		sellInput.addEventListener("input", (event) => {
			sellTotal.textContent = isNaN(sellInput.valueAsNumber)
				? ""
				: `$${(Number(priceCell.dataset.value) * Number(sellInput.value)).toFixed(2)}`;
		});
	});
</script>

{% endblock %}
